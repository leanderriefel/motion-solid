# motion-solid (agent notes)

Community-maintained SolidJS adapter for the official `motion` package (formerly “framer-motion”). The intent is near feature parity with the Motion/Framer Motion public API, implemented in a Solid-first way, reusing Motion internals where it makes sense.

## Non-negotiables

- 100% type-safe TypeScript (`strict`), no `any`/`as any` (prefer generics, typed wrappers at library boundaries or if needed `unknown`).
- Performance-first: minimize DOM reads/writes, allocations in hot paths, and unnecessary reactive invalidations; keep animations smooth (FPS).
- Readable code and good docs. No filler comments; only document non-obvious decisions and public API behavior.

## Repo layout

- `package/`: the published library (`motion-solid`).
  - `package/src/*`: source of the public API.
  - `package/dist/*`: build output (generated by `zshy`; do not edit by hand).
- `playground/`: Vite + Solid playground for manual testing and demos (uses `motion-solid` via workspace dependency).
- Root `package.json`: Bun workspaces + convenience scripts.

## Build, test, typecheck

- Dev playground: `bun dev` (runs `@motion-solid/playground`).
- Build library: `bun --filter motion-solid build`
- Unit tests: `bun --filter motion-solid test`
- Typecheck: `bun --filter motion-solid typecheck`

## Library architecture (current)

### Entry point and “`motion.<tag>`”

- `package/src/index.tsx`
  - Exports `motion` (a `Proxy`) that lazily creates and caches `motion.<intrinsic>` components.
  - The `then` trap is explicitly ignored to avoid thenable/promise assimilation edge cases.

### Motion component implementation

- `package/src/createMotionComponent.tsx`
  - `createMotionComponent(tag)` returns a Solid component that wraps an intrinsic element via `solid-js/web` `Dynamic`.
  - Motion-specific props are stripped with `splitProps` using `motionKeys`. If you add new motion props, add them to `motionKeys` to avoid leaking unknown attributes to the DOM.
  - Variants/transition/custom inheritance is implemented with a `MotionContext` and `inherit` (defaults to `true`).
  - `initial` is applied once by directly setting style keys (no animation). `animate()` from `motion` is used for animated updates.
  - Gestures/viewport support uses:
    - `hover()` and `press()` from `motion-dom`
    - `inView()` from `motion`
  - Current target priority: `whileTap` > `whileHover` > `whileInView` > `animate`.
  - Presence integration:
    - Reads `PresenceContext` via `usePresence()`.
    - Registers/unregisters each motion component within a presence boundary.
    - When leaving, plays `exit` (if provided) and calls `onExitComplete` when done so the boundary can unmount.

### Presence / AnimatePresence

- `package/src/presence.tsx`
  - `Presence` is a minimal presence boundary: it keeps children mounted until all registered motion children finish exit.
  - Exported alias: `AnimatePresence = Presence`.
  - API today: `when`, `children`, optional `fallback`.

### Types and utilities

- `package/src/types.ts`
  - Public types for targets, variants, transitions, and motion props (`MotionAnimationProps`, `MotionProps`, etc.).
  - Motion targets are expressed via `motion-dom` types (`DOMKeyframesDefinition`, `AnimationOptions`, `ResolvedValues`).
- `package/src/transform.ts`
  - Re-exports `transform`/`transformValue` from `motion-dom`.

## Conventions for changes

- Prefer improving types at boundaries instead of sprinkling casts. If an upstream API is poorly typed, introduce a small typed adapter and keep casts inside it.
- Keep public API behavior aligned with Motion/Framer Motion semantics unless there’s a Solid-specific reason to diverge; document divergences.
- Avoid reactive “thrash”: do work in `createEffect` only when necessary, cancel side effects in `onCleanup`, and keep derived computations in `createMemo`.
- Match existing style (2-space indent, double quotes, no semicolons) unless the repo adopts a formatter.
- Keep docs current:
  - `README.md` (repo roadmap/TODO)
  - `package/README.md` (user-facing API and examples)

## Project direction

- IMPORTANT: THIS IS NOT A MOTION/FRAMER-MOTION WRAPPER. THIS IS AN ACTUAL LIBRARY THAT USES MOTION'S INTERNALS TO ACHIEVE ITS GOALS TOGETHER WITH IT'S OWN IMPLEMENTED FUNCTIONS.
- API compatibility target: prefer the newer `motion` API surface.
- SSR/hydration is a first-class goal:
  - On the server, motion components should render as normal components in their starting condition (no runtime animation work, no DOM access).
  - Avoid relying on effects for initial render output; anything that must be reflected in SSR HTML should be computed into props/attributes.
- Presence should evolve towards Motion’s feature-rich `AnimatePresence` (modes, initial handling, etc.), rather than staying minimal.
- Full MotionValue support:
  - Accept MotionValues in targets/props where Motion does (and update DOM reactively without losing type-safety).
  - Ensure subscriptions are created/cleaned up efficiently and are SSR-safe.
